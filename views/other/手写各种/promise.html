<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise、 | 个人博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="https://colastar.github.io/blogs/views/images/favicon.ico">
    <link rel="manifest" href="https://colastar.github.io/blogs/views/js/manifest.json">
    <link rel="apple-touch-icon" href="https://colastar.github.io/blogs/views/images/logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://colastar.github.io/blogs/views/js/tj.js"></script>
    <script src="https://colastar.github.io/blogs/views/js/code.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="谁家今夜扁舟子，何处相思明月楼？">
    
    <link rel="preload" href="/assets/css/0.styles.5d8619ec.css" as="style"><link rel="preload" href="/assets/js/app.8a41a755.js" as="script"><link rel="preload" href="/assets/js/2.933437e1.js" as="script"><link rel="preload" href="/assets/js/145.d67f904e.js" as="script"><link rel="prefetch" href="/assets/js/10.328e6b0c.js"><link rel="prefetch" href="/assets/js/100.a49f2b25.js"><link rel="prefetch" href="/assets/js/101.0a0c9219.js"><link rel="prefetch" href="/assets/js/102.b9043754.js"><link rel="prefetch" href="/assets/js/103.0a6fa45c.js"><link rel="prefetch" href="/assets/js/104.25617606.js"><link rel="prefetch" href="/assets/js/105.e4d0ba63.js"><link rel="prefetch" href="/assets/js/106.3db84ba2.js"><link rel="prefetch" href="/assets/js/107.9e98a12e.js"><link rel="prefetch" href="/assets/js/108.94b67074.js"><link rel="prefetch" href="/assets/js/109.fde1c4fe.js"><link rel="prefetch" href="/assets/js/11.a0604d4c.js"><link rel="prefetch" href="/assets/js/110.4ac5b720.js"><link rel="prefetch" href="/assets/js/111.6b69f533.js"><link rel="prefetch" href="/assets/js/112.8f995d95.js"><link rel="prefetch" href="/assets/js/113.bb30b340.js"><link rel="prefetch" href="/assets/js/114.2c94a17c.js"><link rel="prefetch" href="/assets/js/115.98f7c90a.js"><link rel="prefetch" href="/assets/js/116.6c13a637.js"><link rel="prefetch" href="/assets/js/117.a59255ad.js"><link rel="prefetch" href="/assets/js/118.1dbf0298.js"><link rel="prefetch" href="/assets/js/119.0d02ee8d.js"><link rel="prefetch" href="/assets/js/12.f2faabda.js"><link rel="prefetch" href="/assets/js/120.73aa7663.js"><link rel="prefetch" href="/assets/js/121.600321cd.js"><link rel="prefetch" href="/assets/js/122.c85cadb1.js"><link rel="prefetch" href="/assets/js/123.fdc9ffb9.js"><link rel="prefetch" href="/assets/js/124.01b5ae29.js"><link rel="prefetch" href="/assets/js/125.63c5bdff.js"><link rel="prefetch" href="/assets/js/126.d3202b43.js"><link rel="prefetch" href="/assets/js/127.b89e84ed.js"><link rel="prefetch" href="/assets/js/128.8584b521.js"><link rel="prefetch" href="/assets/js/129.76dccf91.js"><link rel="prefetch" href="/assets/js/13.778ec983.js"><link rel="prefetch" href="/assets/js/130.86df5617.js"><link rel="prefetch" href="/assets/js/131.8d19887c.js"><link rel="prefetch" href="/assets/js/132.a4b56ad5.js"><link rel="prefetch" href="/assets/js/133.686e98c5.js"><link rel="prefetch" href="/assets/js/134.94a16a86.js"><link rel="prefetch" href="/assets/js/135.15f10779.js"><link rel="prefetch" href="/assets/js/136.c5f44409.js"><link rel="prefetch" href="/assets/js/137.10369fcd.js"><link rel="prefetch" href="/assets/js/138.e13e5750.js"><link rel="prefetch" href="/assets/js/139.b731f241.js"><link rel="prefetch" href="/assets/js/14.41ba2c07.js"><link rel="prefetch" href="/assets/js/140.b566f0ca.js"><link rel="prefetch" href="/assets/js/141.6a827c0f.js"><link rel="prefetch" href="/assets/js/142.76d9afc8.js"><link rel="prefetch" href="/assets/js/143.d5db2ca5.js"><link rel="prefetch" href="/assets/js/144.3d1cc5fe.js"><link rel="prefetch" href="/assets/js/146.79fa214f.js"><link rel="prefetch" href="/assets/js/147.88945834.js"><link rel="prefetch" href="/assets/js/148.8f0ec7ef.js"><link rel="prefetch" href="/assets/js/149.c55ee4f4.js"><link rel="prefetch" href="/assets/js/15.13f65559.js"><link rel="prefetch" href="/assets/js/150.4a31a779.js"><link rel="prefetch" href="/assets/js/151.815d15eb.js"><link rel="prefetch" href="/assets/js/152.4d8bb893.js"><link rel="prefetch" href="/assets/js/153.cff0f554.js"><link rel="prefetch" href="/assets/js/154.90a0dc7b.js"><link rel="prefetch" href="/assets/js/155.213894a9.js"><link rel="prefetch" href="/assets/js/16.c82c3167.js"><link rel="prefetch" href="/assets/js/17.36ae2f47.js"><link rel="prefetch" href="/assets/js/18.2fa60553.js"><link rel="prefetch" href="/assets/js/19.a9818154.js"><link rel="prefetch" href="/assets/js/20.30ddcc8b.js"><link rel="prefetch" href="/assets/js/21.741a6a87.js"><link rel="prefetch" href="/assets/js/22.391b2947.js"><link rel="prefetch" href="/assets/js/23.ded7ab9b.js"><link rel="prefetch" href="/assets/js/24.7c28b02f.js"><link rel="prefetch" href="/assets/js/25.aaa14395.js"><link rel="prefetch" href="/assets/js/26.bb47061d.js"><link rel="prefetch" href="/assets/js/27.e76c38ed.js"><link rel="prefetch" href="/assets/js/28.a99fa8c8.js"><link rel="prefetch" href="/assets/js/29.919ade27.js"><link rel="prefetch" href="/assets/js/3.aac71cf4.js"><link rel="prefetch" href="/assets/js/30.e7a442f8.js"><link rel="prefetch" href="/assets/js/31.d8a99e31.js"><link rel="prefetch" href="/assets/js/32.23de2466.js"><link rel="prefetch" href="/assets/js/33.1787e140.js"><link rel="prefetch" href="/assets/js/34.95738017.js"><link rel="prefetch" href="/assets/js/35.efb0f68d.js"><link rel="prefetch" href="/assets/js/36.f243f134.js"><link rel="prefetch" href="/assets/js/37.bec6b3a8.js"><link rel="prefetch" href="/assets/js/38.7666590c.js"><link rel="prefetch" href="/assets/js/39.e0e2866a.js"><link rel="prefetch" href="/assets/js/4.b02cea19.js"><link rel="prefetch" href="/assets/js/40.c46f1c8e.js"><link rel="prefetch" href="/assets/js/41.b6bdfcdd.js"><link rel="prefetch" href="/assets/js/42.d8190088.js"><link rel="prefetch" href="/assets/js/43.f82b77f4.js"><link rel="prefetch" href="/assets/js/44.23d67e67.js"><link rel="prefetch" href="/assets/js/45.f478b646.js"><link rel="prefetch" href="/assets/js/46.610ec3cd.js"><link rel="prefetch" href="/assets/js/47.e4802628.js"><link rel="prefetch" href="/assets/js/48.45991eff.js"><link rel="prefetch" href="/assets/js/49.f8c9fc07.js"><link rel="prefetch" href="/assets/js/5.3fe9d0bc.js"><link rel="prefetch" href="/assets/js/50.33285787.js"><link rel="prefetch" href="/assets/js/51.054978eb.js"><link rel="prefetch" href="/assets/js/52.6fec627b.js"><link rel="prefetch" href="/assets/js/53.4634769a.js"><link rel="prefetch" href="/assets/js/54.622c78a3.js"><link rel="prefetch" href="/assets/js/55.29ad87f2.js"><link rel="prefetch" href="/assets/js/56.a20f65e7.js"><link rel="prefetch" href="/assets/js/57.41803c6e.js"><link rel="prefetch" href="/assets/js/58.6cdc51a8.js"><link rel="prefetch" href="/assets/js/59.7ae04bde.js"><link rel="prefetch" href="/assets/js/6.af2d9c4a.js"><link rel="prefetch" href="/assets/js/60.7fc50d50.js"><link rel="prefetch" href="/assets/js/61.beb3b4f8.js"><link rel="prefetch" href="/assets/js/62.a2020bea.js"><link rel="prefetch" href="/assets/js/63.e733ba7a.js"><link rel="prefetch" href="/assets/js/64.8c8d1551.js"><link rel="prefetch" href="/assets/js/65.2897dde1.js"><link rel="prefetch" href="/assets/js/66.9ef08533.js"><link rel="prefetch" href="/assets/js/67.59db1434.js"><link rel="prefetch" href="/assets/js/68.9b665bf4.js"><link rel="prefetch" href="/assets/js/69.645fd83b.js"><link rel="prefetch" href="/assets/js/7.0c0f9c31.js"><link rel="prefetch" href="/assets/js/70.b4f44467.js"><link rel="prefetch" href="/assets/js/71.093ec435.js"><link rel="prefetch" href="/assets/js/72.c394e217.js"><link rel="prefetch" href="/assets/js/73.8e1097ea.js"><link rel="prefetch" href="/assets/js/74.23f472fc.js"><link rel="prefetch" href="/assets/js/75.8a824f7f.js"><link rel="prefetch" href="/assets/js/76.f8f8fdf7.js"><link rel="prefetch" href="/assets/js/77.c59eda3e.js"><link rel="prefetch" href="/assets/js/78.bc9899ce.js"><link rel="prefetch" href="/assets/js/79.e8cbaed1.js"><link rel="prefetch" href="/assets/js/8.9850b51a.js"><link rel="prefetch" href="/assets/js/80.699b07e4.js"><link rel="prefetch" href="/assets/js/81.88952008.js"><link rel="prefetch" href="/assets/js/82.767cf66f.js"><link rel="prefetch" href="/assets/js/83.fbdfebad.js"><link rel="prefetch" href="/assets/js/84.aebb55a8.js"><link rel="prefetch" href="/assets/js/85.62b89ee1.js"><link rel="prefetch" href="/assets/js/86.00623ac8.js"><link rel="prefetch" href="/assets/js/87.61fe2798.js"><link rel="prefetch" href="/assets/js/88.d9db1e70.js"><link rel="prefetch" href="/assets/js/89.f6647fec.js"><link rel="prefetch" href="/assets/js/9.43209c57.js"><link rel="prefetch" href="/assets/js/90.194aa88c.js"><link rel="prefetch" href="/assets/js/91.09fb1d76.js"><link rel="prefetch" href="/assets/js/92.2a400a87.js"><link rel="prefetch" href="/assets/js/93.1dbb98b7.js"><link rel="prefetch" href="/assets/js/94.896666ee.js"><link rel="prefetch" href="/assets/js/95.65130412.js"><link rel="prefetch" href="/assets/js/96.74de30a0.js"><link rel="prefetch" href="/assets/js/97.1120689a.js"><link rel="prefetch" href="/assets/js/98.5c1bb51a.js"><link rel="prefetch" href="/assets/js/99.634aa376.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5d8619ec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow down"></span></button> <button type="button" aria-label="博文" class="mobile-dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/no.0/js/es6.html" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/javascript-QA/javascriptqa.html" class="nav-link">
  javaScript与测试工程师
</a></li><li class="dropdown-item"><!----> <a href="/no.1/函数式编程/函数式编程.html" class="nav-link">
  编程相关
</a></li><li class="dropdown-item"><!----> <a href="/no.2/http.html" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/no.3/webpack.html" class="nav-link">
  前端自动化
</a></li><li class="dropdown-item"><!----> <a href="/no.4/前端性能优化.html" class="nav-link">
  前端优化
</a></li><li class="dropdown-item"><!----> <a href="/no.5/css工作流.html" class="nav-link">
  css相关
</a></li><li class="dropdown-item"><!----> <a href="/no.6/react/react.html" class="nav-link">
  框架相关
</a></li><li class="dropdown-item"><!----> <a href="/no.7/计算机组成原理.html" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-item"><!----> <a href="/no.8/数据结构与算法.html" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/node/node/node.html" class="nav-link">
  node相关
</a></li><li class="dropdown-item"><!----> <a href="/no.10/网络安全.html" class="nav-link">
  网络安全
</a></li><li class="dropdown-item"><!----> <a href="/other/git/git命令全集.html" class="nav-link">
  其他相关
</a></li></ul></div></div><div class="nav-item"><a href="/other/手写各种/手写代码实现.html" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="https://github.com/ColaStar/blogs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博文" class="dropdown-title"><span class="title">博文</span> <span class="arrow down"></span></button> <button type="button" aria-label="博文" class="mobile-dropdown-title"><span class="title">博文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/no.0/js/es6.html" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/javascript-QA/javascriptqa.html" class="nav-link">
  javaScript与测试工程师
</a></li><li class="dropdown-item"><!----> <a href="/no.1/函数式编程/函数式编程.html" class="nav-link">
  编程相关
</a></li><li class="dropdown-item"><!----> <a href="/no.2/http.html" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/no.3/webpack.html" class="nav-link">
  前端自动化
</a></li><li class="dropdown-item"><!----> <a href="/no.4/前端性能优化.html" class="nav-link">
  前端优化
</a></li><li class="dropdown-item"><!----> <a href="/no.5/css工作流.html" class="nav-link">
  css相关
</a></li><li class="dropdown-item"><!----> <a href="/no.6/react/react.html" class="nav-link">
  框架相关
</a></li><li class="dropdown-item"><!----> <a href="/no.7/计算机组成原理.html" class="nav-link">
  计算机组成原理
</a></li><li class="dropdown-item"><!----> <a href="/no.8/数据结构与算法.html" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/node/node/node.html" class="nav-link">
  node相关
</a></li><li class="dropdown-item"><!----> <a href="/no.10/网络安全.html" class="nav-link">
  网络安全
</a></li><li class="dropdown-item"><!----> <a href="/other/git/git命令全集.html" class="nav-link">
  其他相关
</a></li></ul></div></div><div class="nav-item"><a href="/other/手写各种/手写代码实现.html" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="https://github.com/ColaStar/blogs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/other/Git代码提交规范.html" class="sidebar-link">Git代码提交规范</a></li><li><a href="/other/eventLoop/eventLoop.html" class="sidebar-link">Event Loop 总结</a></li><li><a href="/other/eventLoop.html" class="sidebar-link">Event Loop 总结</a></li><li><a href="/other/git/git命令全集.html" class="sidebar-link">常用 Git 命令清单</a></li><li><a href="/other/git/git版本管理规范.html" class="sidebar-link">git版本管理规范</a></li><li><a href="/other/typeScript.html" class="sidebar-link">TypeScript入门</a></li><li><a href="/other/优雅降级与渐进增强.html" class="sidebar-link">优雅降级与渐进增强</a></li><li><a href="/other/前端协作规范.html" class="sidebar-link">前端协作规范</a></li><li><a href="/other/前端路由.html" class="sidebar-link">前端路由</a></li><li><a href="/other/手写各种/promise.html" class="active sidebar-link">Promise、</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#实现简单的同步promise" class="sidebar-link">实现简单的同步Promise</a></li><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#增加异步功能" class="sidebar-link">增加异步功能</a></li><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#增加链式调用then" class="sidebar-link">增加链式调用then</a></li><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#catch-finally方法增加" class="sidebar-link">catch|finally方法增加</a></li><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#all-race-resolve-reject等方法" class="sidebar-link">all race resolve reject等方法</a></li><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#实现一个promise的延迟对象defer" class="sidebar-link">实现一个promise的延迟对象defer</a></li><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#最终测试" class="sidebar-link">最终测试</a></li><li class="sidebar-sub-header"><a href="/other/手写各种/promise.html#一些-promise-的面试题" class="sidebar-link">一些 Promise 的面试题</a></li></ul></li><li><a href="/other/手写各种/手写代码实现.html" class="sidebar-link">面试</a></li><li><a href="/other/正则相关.html" class="sidebar-link">什么是正则表达式呢？</a></li><li><a href="/other/网站令浏览器崩溃的原因.html" class="sidebar-link">网站导致浏览器崩溃的原因</a></li><li><a href="/other/重构.html" class="sidebar-link">重构 - 改善既有代码的设计</a></li><li><a href="/other/错误日志监控.html" class="sidebar-link">前端错误监控以及日志管理</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise、"><a href="#promise、" aria-hidden="true" class="header-anchor">#</a> Promise、</h1> <blockquote><p>实现步骤</p></blockquote> <ul><li>实现简单的同步Promise</li> <li>增加异步功能</li> <li>增加链式调用then</li> <li>增加catch finally方法</li> <li>增加all race 等方法</li> <li>实现一个promise的延迟对象defer</li> <li>最终测试</li></ul> <h2 id="实现简单的同步promise"><a href="#实现简单的同步promise" aria-hidden="true" class="header-anchor">#</a> 实现简单的同步Promise</h2> <p>首先要知道：</p> <ul><li><p>Promise内部维护着三种状态：pending（进行中）、resolved（任务执行成功）、reject（任务失败结果），⚠️切记：三种状态，只要改变就不能再被改成其他状态；即pending-&gt;resolve后是不能再转变成别的状态。</p></li> <li><p>Promise 内部有一个value 属性，value值即任务执行成功返回的结果；⚠️如果在value可以是任何值但是如果想要执行异步任务是必须返回一个promise对象，当然这个说的是在then函数中了，</p></li> <li><p>Promise 内部有一个 reason 属性，用来存放 Promise 状态变为 rejected 的原因</p></li> <li><p>简述：内部有个 state，doneList，failList，方法 resolve，reject，返回 fn(resolve, reject)。原型链有个 then，里面做的事情就是把函数参数推入 doneList 和 failList。然后 resolve 里执行的逻辑就是拿出 doneList 顺序执行下去，reject 执行 failList。</p></li></ul> <p>接下来让我实现一下同步的Promise函数
注意1.2.3.4.5</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>function Promise(executor) {
    let _this = this;
    /** 2 定义初始的一些变量 */
    this.value = null;
    this.status = 'pending';
    this.reason = null

    /** 3 定义初始的成功和失败函数 */
    function resolve(value) {
        /** 4 判断状态是不是初始状态pending 
         *    是就转换状态 否则不转换 
         *    确保状态的变化后的不可变性 */
        if (_this.status == 'pending') {
            this.status = 'resloved';
            this.value = value
        }
    }

    function reject(reason) {
        /** 5 同上 */
        if (_this.status === 'pending') {
            that.status = 'rejected';
            that.reason = reason;
        }
    }
    /**
     * 1 Promise中首先传了一个executor，它是一个函数
     *   executor函数中又传了两个函数，分别是resolve和reject
     *   很显然 resolve是成功回调，reject是失败的回调
     */
    executor(resolve, reject);
}
/**定义promise的then方法
    then方法上面有两个回调 一个是成功后的方法 另一个是失败后的方法
 *    根据成功或失败的状态去执行相关成功onFilfulled()或者失败onRejected()的回调方法*/
Promise.prototype.then = function (onFilfulled, onRejected) {
    let _this = this;
    /** 7 如果状态已经变更为resolved 
     *    说明resolve方法已经被调用
     *    那么此时就执行成功的回调函数onFilfulled
     *    并传入参数 that.value
     * */
    console.log(_this.status)
    if (_this.status === 'resloved') {
        onFilfulled(_this.value)
    }
    /** 8 如果状态已经变更为reject
     *    说明resolve方法已经被调用
     *    那么此时就执行成功的回调函数onRejected
     *    并传入参数 that.reason
     * */
    if (_this.status === 'rejected') {
        onRejected(_this.reason)
    }
}

// module.exports = Promise;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="增加异步功能"><a href="#增加异步功能" aria-hidden="true" class="header-anchor">#</a> 增加异步功能</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>function Promise(executor) {
    let _this = this;
    this.value = null;
    this.status = 'pending';
    this.reason = null;
     /** 1 因为异步不是立即执行 状态不会变更 成功或失败的回调函数也不会执行
     *    所以先定义好存放成功或失败回调函数的数组 
     *    以便将成功或失败的回调函数先保存起来
     * */
    this.onFilFulledCallbacks = [];
    this.onRejectedCallbacks = [];

    function resolve(value) {
        if (_this.status == 'pending') {
            this.status = 'resloved';
            this.value = value;
            /** 3 成功发布
             *    等待状态发生变更
             *    状态变更后 立即执行之前存放在相应数组中所有的成功的回调函数
             *    即 发布
             */
             this.onFilFulledCallbacks.foEach(fn=&gt;{
                 fn();
             })
        }
    }

    function reject(reason) {
        if (_this.status === 'pending') {
            that.status = 'rejected';
            that.reason = reason;
            /** 4失败 发布
             *    等待状态发生变更
             *    状态变更后 立即执行之前存放在相应数组中所有的失败的回调函数
             *    即 发布
             */
             this.onFilFulledCallbacks.foEach(fn=&gt;{
                 fn();
             })
        }
    }
    executor(resolve, reject);
}
Promise.prototype.then = function (onFilfulled, onRejected) {
    let _this = this;
    if (_this.status === 'resloved') {
        onFilfulled(_this.value)
    }
    if (_this.status === 'rejected') {
        onRejected(_this.reason)
    }
    /** 2 订阅
     *    因为是异步 状态当时并没有立即变更 所以状态还是pending
     *    此时需要把成功或者失败的回调函数存放到对应的数组中
     *    等待状态变更时 再从数组中拿出来去执行
     *    即 订阅
     *    *存放数组时 为了执行时方便 需要把回调函数的外层包裹一层空函数
     */
    if(_this.status === 'pending'){
        _this.onFilFulledCallbacks.push(function(){
            onFilfulled(_this.value);
        });
    }
    if(_this.status === 'pending'){
        _this.onRejectedCallbacks.push(function(){
            onRejected(_this.reason);
        });
    }
}

module.exports = Promise;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p>至此，我们实现了异步的Promise.其实这里的实现异步的思想就是发布订阅.</p> <p>en～ok.高能预警🐯.接下来就稍稍复杂了 因为我们要实现链式调用then。 要实现这个功能那我们就要重写then方法，并在then方法中重新返回一个Promise,只有这样，才可以实现多次调用then.而且要新增一个解析返回值是否为promise的函数.</p> <p>稍微捋一下逻辑</p> <ul><li>如果一个then方法返回的是一个普通值的话，这个值会传递给下一个then中做resolve的返回值；</li> <li>如果then方法返回的是一个promise的话，我们要根据上一个then的状态（成功与失败）来决定下一个then的成功与失败</li></ul> <h2 id="增加链式调用then"><a href="#增加链式调用then" aria-hidden="true" class="header-anchor">#</a> 增加链式调用then</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>function Promise(executor) {
    let that = this;
    that.status = 'pending';
    that.value = null;
    that.reason = null;
    that.onFilFulledCallbacks = [];
    that.onRejectedCallbacks = [];
   
    function resolve(value) {
        if (that.status === 'pending') {
            that.status = 'resolved';
            that.value = value;
            that.onFilFulledCallbacks.forEach((fn) = &amp; gt; {
                fn();
            });
        }
    }

    function reject(reason) {
        if (that.status === 'pending') {
            that.status = 'rejected';
            that.reason = reason;
            that.onRejectedCallbacks.forEach((fn) = &amp; gt; {
                fn();
            });
        }
    }
    executor(resolve, reject);
}

Promise.prototype.then = function (onFilfulled, onRejected) {
    let that = this;
    /** 1 让promise2等于一个新的Promise 并将promise2返回 */
    let promise2 = new Promise((resolve, reject) = &amp; gt; {
        if (that.status === 'resolved') {
            /** 2 因为返回了promise2 
             *  并且第3步resolvePromiseRelation函数中传递了promise2
             *  而目前promise2并没有拿到
             *  所以加一个定时器 异步执行 等到promise2拿到后 
             *  再去执行 resolvePromiseRelation()方法 并将promise2传递进去*/
            setTimeout(() = &amp; gt; {
                try {
                    let promise3 = onFilfulled(that.value);
                    /** 3 判断新返回值是什么类型的函数
                     *  并将当前的promise：promise2  新的返回值：promise3 
                     *  和 成功时回调：esolve  失败时回调：reject 作为参数传进去 */
                    resolvePromiseRelation(promise2, promise3, resolve, reject);
                } catch (e) {
                    reject(e);
                }
            }, 0);
        }
        if (that.status === 'rejected') {
            /** 同2 */
            setTimeout(() = &amp; gt; {
                try {
                    let promise3 = onRejected(that.reason);
                    /** 同3*/
                    resolvePromiseRelation(promise2, promise3, resolve, reject);
                } catch (e) {
                    reject(e);
                }
            }, 0);
        }
        if (that.status === 'pending') {
            that.onFilFulledCallbacks.push(function () {
                /** 同2 */
                setTimeout(() = &amp; gt; {
                    try {
                        let promise3 = onFilfulled(that.value);
                        /** 同3*/
                        resolvePromiseRelation(promise2, promise3, resolve, reject);
                    } catch (e) {
                        reject(e);
                    }
                }, 0);
            });
        }
        if (that.status === 'pending') {
            that.onRejectedCallbacks.push(function () {
                /** 同2 */
                setTimeout(() = &amp; gt; {
                    try {
                        let promise3 = onRejected(that.reason);
                        /** 同3*/
                        resolvePromiseRelation(promise2, promise3, resolve, reject);
                    } catch (e) {
                        reject(e);
                    }
                }, 0);
            });
        }
    });
    /** 同1 */
    return promise2;
}

function resolvePromiseRelation(promise2, promise3, resolve, reject) {
    /** 4 防止自己等待自己 一直循环等待 */
    if (promise2 === promise3) {
        return reject(new TypeError('循环引用了!'));
    }
    /**  8 一个标示 表示当前没有被调用过 
     *   确保resolve或者reject后的状态不会再次发生变更
     */
    let called;
    /** 5 保证promise3是一个引用类型
     *  判断新返回值promise3的类型 
     *  如果是普通值常量 就直接resolve导出 */
    if (promise3 !== null &amp; amp; &amp; amp;
        (typeof promise3 === 'object' || typeof promise3 === 'function')) {
        try {
            let then = promise3.then;
            /** 6 确保promise3是一个Promise
             *  判断promise3的then方法
             *  如果存在 并且是一个function类型 
             *  就表示promise3是一个Promise */
            if (typeof then === 'function') {
                /** 9 执行promise3的then方法
                 *  因为promise3也是一个Promise
                 *  需要再次解析promise3的then方法
                 *  直到解析到最后的返回值不是一个Promise类型为止
                 */
                then(promise3, (promise4) = &amp; gt; {
                    /** 同8 */
                    if (called) return;
                    called = true;
                    /** 10 递归解析新的返回值的类型
                     *  解析到返回值不是一个Promise类型为止
                     */
                    resolvePromiseRelation(promise3, promise4, resolve, reject);
                }, (r) = &amp; gt; {
                    /** 同8 */
                    if (called) return;
                    called = true;
                    reject(r);
                });
            } else {
                /** 7 此时promise3是一个普通对象 直接resolve() */
                resolve(promise3);
            }
        } catch (e) {
            /** 同8 */
            if (called) return;
            called = true;
            reject(e);
        };
    } else {
        //常量
        /** 同5 普通值直接resolve()*/
        resolve(promise3);
    }
}

module.exports = Promise;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br></div></div><p>ok. 至此 我们已经实现了Promsie的异步和链式调用. Promise中比较复杂的部分我们已经搞定了 接下来就是添加一些方法，其实这部分反而没那么复杂了.</p> <h2 id="catch-finally方法增加"><a href="#catch-finally方法增加" aria-hidden="true" class="header-anchor">#</a> catch|finally方法增加</h2> <ul><li>catch : catch方法本质上就是一个then方法的变形，只有失败时的回调 没有成功时的回调</li> <li>catch : finally方法的作用是不管 Promise 对象最后状态如何，都会执行操作.其实说白了就是在then方法的成功和失败的回调函数中都执行该方法就行了.</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>
/** 1 直接返回this的then方法
 *  因为catch只捕获错误 所以resolve直接为null
 *  返回reject就好*/
Promise.prototype.catch = function(errFn){
    return this.then(null,errFn);
}

/** 3 finally实现起来也很简单 
 *  分别在resolve和reject中执行fn就好 
 *  最后再把this返回出去就好
*/
Promise.prototype.finally = function(fn){
    this.then(()=&amp;gt;{
        fn();
    },()=&amp;gt;{
        fn();
    });
    return this;
}

module.exports = Promise;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="all-race-resolve-reject等方法"><a href="#all-race-resolve-reject等方法" aria-hidden="true" class="header-anchor">#</a> all race resolve reject等方法</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>//类方法，多个 Promise 任务同时执行。
//如果全部成功执行，则以数组的方式返回所有 Promise 任务的执行结果。 如果有一个 Promise 任务 rejected，则只返回 rejected 任务的结果。

/** 1 直接在构造函数上增加all方法
 *  它返回的也是一个Promise
 *  等待参数数组中所有的promise都执行完毕后
 *  再返回结果
 */
Promise.all = function(values){
    return new Promise((resolve,reject)=&amp;gt;{
        /** 2 定义一个存放最终结果的数组result和一个index */ 
        let results = [];
        let index = 0;
        /** 3 定义一个方法addToArr()  
         *  让index每次执行增加results数组元素的函数的时候都+1
         *  当index === values的长度的时候 说明此时所有promsie都执行完毕并放到的数组中
         *  然后直接resolve(results)就行了
        */
        function addToArr(key,value){
            index++;
            results[key] = value;
            /** 6 当满足条件时 说明所有的promise都执行完毕 直接resolve(results) */
            if(index === values.length){
                resolve(results);
            }
        }
        /** 4 循环values中的每一项promsie */
        for(let i = 0; i &amp;lt; values.length; i++){
            let current = values[i];
            /** 5 判断每一项promise的返回值是不是一个Promsie
             *  是的话就执行该Promise的then方法 拿到返回值 并放到数组results中
             *  是一个普通值的话就直接将该值放到数组results中
             */
            if(current &amp;amp;&amp;amp; current.then &amp;amp;&amp;amp; typeof current.then === 'function'){
                current.then((value)=&amp;gt;{
                    /** 同5 把返回值放到数组results中*/
                    addToArr(i,value);
                },reject);
            }else{
                /** 同5 把返回值放到数组results中*/
                addToArr(i,current);
            }
        }
    });
}

//类方法，多个 Promise 任务同时执行，返回最先执行结束的 Promise 任务的结果，不管这个 Promise 结果是成功还是失败。 
。
/** race方法相比较于all方法简单很多
 *  因为race中的promsie成功resolve一个 
 *  整个race就resolve */
Promise.race = function(values){
    return new Promise((resolve,reject)=&amp;gt;{
        /** 同4 */
        for(let i = 0; i &amp;lt; values.length; i++){
            let current = values[i];
            /** 同5 */
            if(current&amp;amp;&amp;amp;current.then&amp;amp;&amp;amp;typeof current.then === 'function'){
                /** 7 直接执行then就好 */
                current.then(resolve,reject);
            }else{
                /** 8 普通值直接resolve */
                resolve(current);
            }
        }
    });
}


// resolve方法
Promise.resolve = function(value){
    return new Promise((resolve,reject)=&amp;gt;{
        resolve(value);
    });
}
// reject方法
Promise.reject = function(reason){
    return new Promise((resolve,reject)=&amp;gt;{
        reject(reason);
    });
}

module.exports = Promise;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h2 id="实现一个promise的延迟对象defer"><a href="#实现一个promise的延迟对象defer" aria-hidden="true" class="header-anchor">#</a> 实现一个promise的延迟对象defer</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 实现一个promise的延迟对象 defer
Promise.defer = Promise.deferred = function(){
    let dfd = {};
    dfd.promise = new Promise((resolve, reject)=&amp;gt;{
        dfd.resolve = resolve;
        dfd.reject = reject;
    });
    return dfd;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="最终测试"><a href="#最终测试" aria-hidden="true" class="header-anchor">#</a> 最终测试</h2> <ul><li>测试当前代码是否符合Promise/A+规范</li> <li>全局安装 npm i -g promises-aplus-tests</li> <li>文件所在目录运行以下命令 (例如你的文件名为:MyPrommise.js)</li> <li>promise-aplus-tests MyPrommise.js</li> <li>等待</li> <li>ok.</li></ul> <h2 id="一些-promise-的面试题"><a href="#一些-promise-的面试题" aria-hidden="true" class="header-anchor">#</a> 一些 Promise 的面试题</h2> <blockquote><p>第一题</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>const promise = new Promise((resolve, reject) =&gt; {
    console.log(1)
    resolve()
    console.log(2)
})
promise.then(() =&gt; {
    console.log(3)
})
console.log(4)

// 1 2 4 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>记住 new Promise 里的参数函数，是同步被执行的，故而先输出 1，2.</p> <p>resolve 后还需要等待进入下一个事件循环。then 把参数函数推入微任务队列，并不直接执行。</p> <p>输出 4，接着事件循环进入下一轮，输出 3.</p> <blockquote><p>第二题 **</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>var promise = new Promise(function(resolve, reject){
  setTimeout(function() {
    resolve(1);
  }, 3000)
})

请问这三种有何不同？

promise.then(() =&gt; {
  return Promise.resolve(2);
}).then((n) =&gt; {
  console.log(n)
});

promise.then(() =&gt; {
  return 2
}).then((n) =&gt; {
  console.log(n)
});

promise.then(2).then((n) =&gt; {
  console.log(n)
});

// 2 2 1

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>1.输出2。Promise.resolve 就是一个 Promise 对象就相当于返回了一个新的 Promise 对象。然后在下一个事件循环里才会去执行 then</p> <p>2.输出2。和上一点不一样的是，它不用等下一个事件循环。</p> <p>3.输出1。then 和 catch 期望接收函数做参数，如果非函数就会发生 Promise 穿透现象，打印的是上一个 Promise 的返回。</p> <blockquote><p>第三题</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>let a;
const b = new Promise((resolve, reject) =&gt; {
  console.log('promise1');
  resolve();
}).then(() =&gt; {
  console.log('promise2');
}).then(() =&gt; {
  console.log('promise3');
}).then(() =&gt; {
  console.log('promise4');
});

a = new Promise(async (resolve, reject) =&gt; {
  console.log(a);
  await b;
  console.log(a); //已经进入事件循环了
  console.log('after1');
  await a
  resolve(true);
  console.log('after2');
});

console.log('end');

// promise1 undefined  promise2 promise3 promise4  Promise { pending } after1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>第一个输出 promise1，是因为 Promise 里的方法立即执行。接着调用 resolve，只不过 then 里的方法等下一个周期</p> <p>第二个输出 undefined，是因为立即执行执行 a 内部的方法，先 console.log(a)，但此时的 a 还没赋值给左边的变量，所以只能是 undefined。然后 await b 就得等下一个周期执行了。</p> <p>第三个输出 end，自然不意外。</p> <p>接着输出 promise2，promise3，promise4，是因为 await b 等待他执行完了，才轮到 a 内部继续执行。</p> <p>输出 Promise { pending }，，事件都进入了循环了，a 肯定已经被赋值成了 Promise 对象。所以第二遍 console.log(a)，自然就输出这个了。</p> <p>输出 after1 不奇怪。</p> <p>await a 时，a 是必须等待 Promise 的状态从 pending 到 fullfilled 才会继续往下执行，可 a 的状态是一直得不到更改的，所以无法执行下面的逻辑。只要在 await a 上面加一行 resolve() 就能让后面的 after 2 得到输出。</p> <blockquote><p>第四题</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>const promise = new Promise((resolve, reject) =&gt; {
  resolve('success1');
  reject('error');
  resolve('success2');
});

promise
  .then((res) =&gt; {
    console.log('then: ', res);
  })
  .catch((err) =&gt; {
    console.log('catch: ', err);
  });

//'then: success1'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Promise 对象的状态只能被转移一次，resolve('success1') 时状态转移到了 fullfilled 。后面 reject 就调用无效了，因为状态已经不是 pending。</p> <blockquote><p>第五题</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>Promise.resolve()
  .then(() =&gt; {
    return new Error('error!!!')
  })
  .then((res) =&gt; {
    console.log('then: ', res)
  })
  .catch((err) =&gt; {
    console.log('catch: ', err)
  })
  // then:  Error: error!!!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>没有抛出错误和异常，只是 return 了一个对象，哪怕他是 Error 对象，那自然也是正常走 then 的链式调用下去了，不会触发 catch。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/15/2020, 5:02:25 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/other/前端路由.html" class="prev">
        前端路由
      </a></span> <span class="next"><a href="/other/手写各种/手写代码实现.html">
        面试
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8a41a755.js" defer></script><script src="/assets/js/2.933437e1.js" defer></script><script src="/assets/js/145.d67f904e.js" defer></script>
  </body>
</html>
