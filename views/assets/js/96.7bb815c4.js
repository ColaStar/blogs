(window.webpackJsonp=window.webpackJsonp||[]).push([[96],{172:function(s,n,a){"use strict";a.r(n);var e=a(0),t=Object(e.a)({},function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"koa学习记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koa学习记录","aria-hidden":"true"}},[s._v("#")]),s._v(" koa学习记录")]),s._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("Koa 是由 Express 原班人马打造的，致力于成为一个更小、更富有表现力、更健壮的 Web 框架。 使用 koa 编写 web 应用，通过组合不同的 generator，可以免除重复繁琐的回调函数嵌套， 并极大地提升错误处理的效率。koa 不在内核方法中绑定任何中间件， 它仅仅提供了一个轻量优雅的函数库，使得编写 Web 应用变得得心应手。")]),s._v(" "),a("p",[s._v("本教程旨在介绍Koa框架的相关基础知识，能够帮助你快速的上手。")]),s._v(" "),a("h2",{attrs:{id:"环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境","aria-hidden":"true"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),a("p",[s._v("Koa基于node.js,想要使用Koa的话，需要先行下载node.js并且版本需要大于7.6，如果还未下载node.js，直接点击这里下载对应的版本。node下载地址")]),s._v(" "),a("blockquote",[a("p",[s._v("开始")])]),s._v(" "),a("p",[s._v("下载完成之后，检查对应node版本大于7.6之后就可以开始学习Koa了，这里建议使用阮一峰老师的Koa示例库，需要事先安装git。")]),s._v(" "),a("p",[s._v("git clone https://github.com/ruanyf/koa-demos.git")]),s._v(" "),a("p",[s._v("接着进入示例库，安装相应的依赖")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("cd koa-demos\nnpm install\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("基本用法\n创建一个HTTP服务:\\")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("运行这个脚本")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("node demos/01.js\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("打开浏览器访问,访问127.0.0.1:3000。页面显示Not Found,这是由于我们没有告诉Koa需要显示什么内容。")]),s._v(" "),a("h2",{attrs:{id:"context对象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#context对象","aria-hidden":"true"}},[s._v("#")]),s._v(" Context对象")]),s._v(" "),a("p",[s._v("Koa提供一个Context对象，表示一次对话的上下文，("),a("code",[s._v("包括HTTP请求和HTTP响应")]),s._v(")。编写这个对象我们可以返回输出的内容。")]),s._v(" "),a("ul",[a("li",[s._v("Context.response.body 属性代表发送给用户的内容")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  ctx.response.body = 'Hello World';\n};\n\napp.use(main);\napp.listen(3000);\nconst Koa = require('koa');\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("运行这段代码，打开http://127.0.0.1:3000/发现页面输出了Hello World")]),s._v(" "),a("p",[s._v("其中，main函数定义了一个设置输出内容的方法，然后我们使用app.use()调用了main函数。")]),s._v(" "),a("p",[a("strong",[s._v("ctx.response代表了HTTP的Response\nctx.requset代表了HTTP的Request")])]),s._v(" "),a("p",[s._v("HTTP Response类型\nKoa默认返回的数据类型是text/plain,如果想返回其他类型，可以使用ctx.request.accepts类型判断一下，根据客户端希望接受的字段，使用ctx.response.type返回指定的类型。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  if (ctx.request.accepts('xml')) {\n    ctx.response.type = 'xml';\n    ctx.response.body = '<data>Hello World</data>';\n  } else if (ctx.request.accepts('json')) {\n    ctx.response.type = 'json';\n    ctx.response.body = { data: 'Hello World' };\n  } else if (ctx.request.accepts('html')) {\n    ctx.response.type = 'html';\n    ctx.response.body = '<p>Hello World</p>';\n  } else {\n    ctx.response.type = 'text';\n    ctx.response.body = 'Hello World';\n  }\n};\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h2",{attrs:{id:"网页模板"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网页模板","aria-hidden":"true"}},[s._v("#")]),s._v(" 网页模板")]),s._v(" "),a("p",[s._v("实际开发中，返回给用户的网页常常写成模板文件，我们可以让Koa先读取文件，然后将这个模板返回给用户。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const fs = require('fs');\nconst Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  ctx.response.type = 'html';\n  ctx.response.body = fs.createReadStream('./demos/template.html');\n};\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("打开http://127.0.0.1:3000/可以看到输出Hello World")]),s._v(" "),a("h2",{attrs:{id:"路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路由","aria-hidden":"true"}},[s._v("#")]),s._v(" 路由")]),s._v(" "),a("p",[s._v("一个应用由多个页面构成，通过ctx.request.path可以获取用户请求的路径。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  if (ctx.request.path !== '/') {\n    ctx.response.type = 'html';\n    ctx.response.body = '';\n  } else {\n    ctx.response.body = 'Hello World';\n  }\n};\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("我们打开http://127.0.0.1:3000/aa就可以发现出现了一个跳转到首页的链接。")]),s._v(" "),a("h2",{attrs:{id:"koa-route模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koa-route模块","aria-hidden":"true"}},[s._v("#")]),s._v(" koa-route模块")]),s._v(" "),a("p",[s._v("我们可以使用koa-route模块进行路由的跳转。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst route = require('koa-route');\nconst app = new Koa();\n\nconst about = ctx => {\n  ctx.response.type = 'html';\n  ctx.response.body = '';\n};\n\nconst main = ctx => {\n  ctx.response.body ='';\n};\n\napp.use(route.get('/', main));\napp.use(route.get('/about', about));\n\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("这里返回了两个页面，我们可以从index页面跳转到about页面。")]),s._v(" "),a("h2",{attrs:{id:"静态资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#静态资源","aria-hidden":"true"}},[s._v("#")]),s._v(" 静态资源")]),s._v(" "),a("p",[s._v("koa-static模块封装了(图片，字体，样式表等静态资源)。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\nconst path = require('path');\nconst serve = require('koa-static');\n\nconst main = serve(path.join(__dirname));\n//__dirname 表示的是当前你所在文件的目录\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h2",{attrs:{id:"重定向"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重定向","aria-hidden":"true"}},[s._v("#")]),s._v(" 重定向")]),s._v(" "),a("p",[s._v("某些场合，服务器需要重定向访问请求，比如用户登录以后，将他重定向到之前的页面，ctx.requset.redirect()方法可以发送一个302跳转。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst route = require('koa-route');\nconst app = new Koa();\n\nconst redirect = ctx => {\n  ctx.response.redirect('/');\n};\n\nconst main = ctx => {\n  ctx.response.body = 'Hello World';\n};\n\napp.use(route.get('/', main));\napp.use(route.get('/redirect', redirect));\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("本例相当于我们从redirect页面发出了请求，然后页面重定向回了index页面。")]),s._v(" "),a("h2",{attrs:{id:"中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 中间件")]),s._v(" "),a("p",[s._v("Koa最大的特色，也是重要的一个设计就是中间价(middleWare),我们先通过Looger日志了解下打印日志的功能。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  console.log(`${Date.now()} ${ctx.request.method} ${ctx.request.url}`);\n  ctx.response.body = 'Hello World';\n};\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("我们运行这段代码，就可以发现控制台输出")]),s._v(" "),a("p",[s._v("类似这样的代码 1526392654243 GET /")]),s._v(" "),a("blockquote",[a("p",[s._v("中间件的概念")])]),s._v(" "),a("p",[s._v("上一个例子的Looger功能，可以拆分成一个独立的函数。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst logger = (ctx, next) => {\n  console.log(`${Date.now()} ${ctx.request.method} ${ctx.request.url}`);\n  next();\n}\n\nconst main = ctx => {\n  ctx.response.body = 'Hello World';\n};\n\napp.use(logger);\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v('上述例子的Logger函数就是"中间件"的概念，因为它处在HTTP Request和HTTP Response之间，用来实现某种功能，app.use()用来加载中间件。')]),s._v(" "),a("p",[s._v("基本上koa所有的功能都是通过中间件实现的，前面例子里面的main也是中间件。")]),s._v(" "),a("p",[s._v("每个中间件默认接受"),a("strong",[s._v("两个参数")]),s._v("，第一个参数是"),a("code",[s._v("Context")]),s._v("对象，第二个参数是"),a("code",[s._v("next")]),s._v("参数，只要调用next函数，就可以把执行权交给下一个中间件。")]),s._v(" "),a("blockquote",[a("p",[s._v("中间件栈")])]),s._v(" "),a("p",[s._v('多个中间件会形成一个栈的结构，以 先进后出，" first-in-last-out"的顺序执行。')]),s._v(" "),a("p",[s._v("1.最外层的中间件首先执行。")]),s._v(" "),a("p",[s._v("2.调用next函数，把执行权交给下一个中间件。")]),s._v(" "),a("p",[s._v("3…")]),s._v(" "),a("p",[s._v("4.最内层的中间件最后执行。")]),s._v(" "),a("p",[s._v("5.执行结束后，把执行权教回上一层的中间件。")]),s._v(" "),a("p",[s._v("6…")]),s._v(" "),a("p",[s._v("7.最外层的中间件收回执行权后，执行next函数后面的代码。\n"),a("a",{attrs:{"data-fancybox":"",title:"",href:"https://raw.githubusercontent.com/ColaStar/static/master/images/koa.png"}},[a("img",{attrs:{src:"https://raw.githubusercontent.com/ColaStar/static/master/images/koa.png",alt:""}})]),s._v("\n我们直接看下面的例子：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst one = (ctx, next) => {\n  console.log('>> one-step1');\n  next();\n  console.log('<< one-step2');\n}\n\nconst two = (ctx, next) => {\n  console.log('>> two-step1');\n  next();\n  console.log('<< two-step2');\n}\n\nconst three = (ctx, next) => {\n  console.log('>> three-step1');\n  next();\n  console.log('<< three-step2');\n}\n\napp.use(one);\napp.use(two);\napp.use(three);\n\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("控制台输出结果：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(">> one-step1\n>> two-step1\n>> three-step1\n<< three-step2\n<< two-step2\n<< one-step2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("分析：")]),s._v(" "),a("p",[s._v("我们编写了三个中间件，one，two，three，每个中间件内部都分为两个步骤。")]),s._v(" "),a("p",[s._v("当我们先执行app.use(one)后先执行one-step1，然后调用了next函数，此时将执行权交给了下一个中间件two，two执行two-step1后将执行权交给了three，three执行后调用next发现已经没有中间件了，所以先执行内部的three-step2后将执行权返回给two，因此输出了上述结果。")]),s._v(" "),a("p",[s._v("【注】当中间件内部没有next函数的时候，执行权就不会移交到下一个中间件中，比如我们可以删除two步骤的next方法，发现three中间件并没有执行了。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(">> one-step1\n>> two-step1\n<< two-step2\n<< one-step2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("异步中间件")])]),s._v(" "),a("p",[s._v("我们如何在中间件里面进行异步操作(比如读取数据库等)，那么我们需要将中间件改写成async函数，这是一个ES6的语法糖。")]),s._v(" "),a("p",[s._v("这里我们尝试去读取一个本地的模板文件。读取完成之后将它返回：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('const fs = require(\'fs.promised\');\nconst Koa = require(\'koa\');\nconst app = new Koa();\n\nconst main = async function (ctx, next) {\n  ctx.response.type = \'html\';\n  ctx.response.body = await fs.readFile(\'./demos/template.html\', \'utf8\');\n};\n\napp.use(main);\napp.listen(3000);\n\n\n//template.html\n\n<!doctype html>\n\n<html lang="en">\n<head>\n  <meta charset="utf-8">\n\n  <title>The HTML5 Herald</title>\n  <meta name="description" content="HTML5 Template">\n  <meta name="author" content="xxx">\n</head>\n\n<body>\n  <h1>我是模板文件的内容</h1>\n</body>\n</html>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("p",[s._v("执行这段代码后，打开127.0.0.1:3000可以看到输出的文本 —— 我是模板文件的内容")]),s._v(" "),a("blockquote",[a("p",[s._v("中间件的合成")])]),s._v(" "),a("p",[s._v("koa-compose模块可以将多个中间件合成为一个")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst compose = require('koa-compose');\nconst app = new Koa();\n\nconst logger = (ctx, next) => {\n  console.log(`${Date.now()} ${ctx.request.method} ${ctx.request.url}`);\n  next();\n}\n\nconst main = ctx => {\n  ctx.response.body = 'Hello World';\n};\n\nconst middlewares = compose([logger, main]);\n\napp.use(middlewares);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("输出结果：")]),s._v(" "),a("p",[s._v("1526469081713 GET /\nHello World")]),s._v(" "),a("blockquote",[a("p",[s._v("常用中间件")])]),s._v(" "),a("ul",[a("li",[a("code",[s._v("koa-less")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("app.use(require('koa-less')(__dirname + '/public'))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("必须在static前use，不然会无效。 stylesheets文件夹下新建styles.less，并引入所有模块化less文件。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("@import 'foo.less';\n@import 'bar.less';\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("这样所有的样式会被编译成一个style.css。在模板(pug)中引用style.css就行了。")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("koa-session")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 设置app keys，session会根据这个进行加密\napp.keys = ['some secret hurr'];\n// 配置session config\nconst CONFIG = {\n  key: 'bougie:session',\n  /** (string) cookie key (default is koa:sess) */\n  maxAge: 1000 * 60 * 60 * 24 * 7,\n  overwrite: true,\n  /** (boolean) can overwrite or not (default true) */\n  httpOnly: true,\n  /** (boolean) httpOnly or not (default true) */\n  signed: true,\n  /** (boolean) signed or not (default true) */\n  rolling: true,\n  /** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. (default is false) */\n  renew: false,\n  /** (boolean) renew session when session is nearly expired, so we can always keep user logged in. (default is false)*/\n};\n \n// 应用中间件\napp.use(session(CONFIG, app));\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("这个必须在router前use，不然会无效。 基本使用，可以当成一个普通对象")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 赋值\nctx.session.statu = value\n// 取值\nctx.session.statu\n// 删除\nctx.session.statu = null\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("koa-proxies")])])]),s._v(" "),a("p",[s._v("用于代理配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const proxy = require('koa-proxies')\napp.use(proxy('/octocat', {\n  target: 'https://api.github.com/users',  \n  changeOrigin: true,\n  agent: new httpsProxyAgent('http://1.2.3.4:88'),\n  rewrite: path => path.replace(/^\\/octocat(\\/|\\/\\w+)?$/, '/vagusx'),\n  logs: true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("用于代理配置")]),s._v(" "),a("h2",{attrs:{id:"错误处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#错误处理","aria-hidden":"true"}},[s._v("#")]),s._v(" 错误处理")]),s._v(" "),a("p",[s._v("如果代码运行出错的话，我们需要把错误信息返回给用户。HTTP协议约定了许多状态码，类似500和404等。我们可以调用Koa的ctx.throw()方法将错误抛出。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("//500\n\nconst Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  ctx.throw(500);\n};\n\napp.use(main);\napp.listen(3000);\n\n//404\n\nconst Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  ctx.response.status = 404;\n  ctx.response.body = 'Page Not Found';\n};\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("blockquote",[a("p",[a("strong",[s._v("处理错误的中间件")])])]),s._v(" "),a("p",[s._v("为了方便处理错误，我们最好使用try-catch将其捕获。但是为每个中间件都使用try-catch太过麻烦了，我们可以编写一个中间件，将它放置在最外层，负责所有中间件的错误处理。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst handler = async (ctx, next) => {\n  try {\n    await next();\n  } catch (err) {\n    ctx.response.status = err.statusCode || err.status || 500;\n    ctx.response.body = {\n      message: err.message\n    };\n  }\n};\n\nconst main = ctx => {\n  ctx.throw(500);\n};\n\napp.use(handler);\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("blockquote",[a("p",[a("strong",[s._v("error监听事件")])])]),s._v(" "),a("p",[s._v("程序运行过程中一旦出错，Koa会触发一个error事件。监听完这个事件，也可以处理错误。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst main = ctx => {\n  ctx.throw(500);\n};\n\napp.on('error', (err, ctx) => {\n  console.error('server error', err);\n});\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("在app实例里面注册error方法，那么每次错误就会抛出。")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("释放error事件")]),s._v("\n需要注意的是如果错误已经被try…catch捕获到了，那么就不会再触发error事件了，这时必须要手动调用ctx.app.emit()释放。")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst handler = async (ctx, next) => {\n  try {\n    await next();\n  } catch (err) {\n    ctx.response.status = err.statusCode || err.status || 500;\n    ctx.response.type = 'html';\n    ctx.response.body = '<p>Something wrong, please contact administrator.</p>';\n    ctx.app.emit('error', err, ctx);\n  }\n};\n\nconst main = ctx => {\n  ctx.throw(500);\n};\n\napp.on('error', function(err) {\n  console.log('logging error ', err.message);\n  console.log(err);\n});\n\napp.use(handler);\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h2",{attrs:{id:"web-app的功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#web-app的功能","aria-hidden":"true"}},[s._v("#")]),s._v(" Web App的功能")]),s._v(" "),a("h3",{attrs:{id:"cookies"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cookies","aria-hidden":"true"}},[s._v("#")]),s._v(" Cookies")]),s._v(" "),a("p",[s._v("ctx.cookies用来读写Cookie。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa');\nconst app = new Koa();\n\nconst main = function(ctx) {\n  const n = Number(ctx.cookies.get('view') || 0) + 1;\n  ctx.cookies.set('view', n);\n  ctx.response.body = n + ' views';\n}\n\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("运行结果：")]),s._v(" "),a("p",[s._v("打开 http://127.0.0.1:3000 我们发现页面输出了 1 views 当我们每次刷新页面的时候，cookie的值就会加1。")]),s._v(" "),a("h3",{attrs:{id:"表单"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表单","aria-hidden":"true"}},[s._v("#")]),s._v(" 表单")]),s._v(" "),a("p",[s._v("Web应用离不开表单的处理，本质上，表单就是POST方法发送到服务器上的键值对。")]),s._v(" "),a("p",[s._v("koa-body模块可以用来从POST请求的数据体里面提取键值对。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('const Koa = require(\'koa\');\nconst koaBody = require(\'koa-body\');\nconst app = new Koa();\n\nconst main = async function(ctx) {\n  const body = ctx.request.body;\n  if (!body.name) ctx.throw(400, \'.name required\');\n  ctx.body = { name: body.name };\n};\n\napp.use(koaBody());\napp.use(main);\napp.listen(3000);\n\n//打开另外一个终端 运行下面的命令\n\ncurl -X POST --data "name=Jack" 127.0.0.1:3000 {"name":"Jack"}\n\ncurl -X POST --data "name" 127.0.0.1:3000 name required\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("如果POST成功数据会被正常解析，如果发送数据不正确，就会收到错误提示。")]),s._v(" "),a("h3",{attrs:{id:"文件上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件上传","aria-hidden":"true"}},[s._v("#")]),s._v(" 文件上传")]),s._v(" "),a("p",[a("code",[s._v("Koa-body")]),s._v("还可以用来处理文件上传")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const os = require('os');\nconst path = require('path');\nconst Koa = require('koa');\nconst fs = require('fs');\nconst koaBody = require('koa-body');\n\nconst app = new Koa();\n\nconst main = async function(ctx) {\n  const tmpdir = os.tmpdir();\n  const filePaths = [];\n  const files = ctx.request.body.files || {};\n\n  for (let key in files) {\n    const file = files[key];\n    const filePath = path.join(tmpdir, file.name);\n    const reader = fs.createReadStream(file.path);\n    const writer = fs.createWriteStream(filePath);\n    reader.pipe(writer);\n    filePaths.push(filePath);\n  }\n\n  ctx.body = filePaths;\n};\n\napp.use(koaBody({ multipart: true }));\napp.use(main);\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("p",[s._v("打开另一各终端 运行下列代码，注意，路径要使用真实的文件路径")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('curl --form upload=@/path/to/file http://127.0.0.1:3000 ["/tmp/file"]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2017/08/koa.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("文献参考"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"进阶用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进阶用法","aria-hidden":"true"}},[s._v("#")]),s._v(" 进阶用法")]),s._v(" "),a("h3",{attrs:{id:"命名路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命名路由","aria-hidden":"true"}},[s._v("#")]),s._v(" 命名路由")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("router.get('test', '/test/:id', async (ctx, next) => {\n\t ctx.response.body = `<h1>hello world</h1>`\n\t // 访问 test路由 Not Found\n\t // 访问 test/2  hello world\n});\n\nrouter.url('user', 3);\n// => 生成路由 \"/users/3\" \n \nrouter.url('user', { id: 3 });\n// => 生成路由 \"/users/3\" \n \nrouter.use(function (ctx, next) {\n  // 重定向到路由名称为 “sign-in” 的页面 \n  ctx.redirect(ctx.router.url('sign-in'));\n})\n\nrouter.url 方法方便我们在代码中根据路由名称和参数(可选)去生成具体的 URL，而不用采用字符串拼接的方式去生成 URL 了\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h3",{attrs:{id:"多中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多中间件","aria-hidden":"true"}},[s._v("#")]),s._v(" 多中间件")]),s._v(" "),a("p",[a("code",[s._v("koa-router")]),s._v(" 也支持单个路由多中间件的处理。通过这个特性，我们能够为一个路由添加特殊的中间件处理。也可以把一个路由要做的事情拆分成多个步骤去实现，当路由处理函数中有异步操作时，这种写法的可读性和可维护性更高。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("router.get(\n  '/users/:id',\n   async (ctx, next)=>  {\n    return User.findOne(ctx.params.id).then(function(user) {\n      // 首先读取用户的信息，异步操作\n      ctx.user = user;\n      next();\n    });\n  },\n   async (ctx, next)=>  {\n    console.log(ctx.user);\n    // 在这个中间件中再对用户信息做一些处理\n    // => { id: 17, name: \"Alex\" }\n  }\n);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h3",{attrs:{id:"路由前缀"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#路由前缀","aria-hidden":"true"}},[s._v("#")]),s._v(" 路由前缀")]),s._v(" "),a("p",[s._v("通过 "),a("code",[s._v("prefix")]),s._v(" 这个参数，我们可以为一组路由添加统一的前缀，和嵌套路由类似，也方便我们管理路由和简化路由的写法。不同的是，前缀是一个固定的字符串，不能添加动态参数。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const router = new Router({\n  prefix: '/users'\n});\n \nrouter.get('/', ...); // 匹配路由 \"/users\" \nrouter.get('/:id', ...); // 匹配路由 \"/users/:id\" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"url-参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#url-参数","aria-hidden":"true"}},[s._v("#")]),s._v(" URL 参数")]),s._v(" "),a("p",[s._v("koa-router 也支持参数，参数会被添加到 ctx.params 中。参数可以是一个正则表达式，这个功能的实现是通过 "),a("code",[s._v("path-to-regexp")]),s._v(" 来实现的。原理是把 URL 字符串转化成正则对象，然后再进行正则匹配，之前的例子中的 * 通配符就是一种正则表达式。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("router.get('/:category/:title', async (ctx, next) => {\n  console.log(ctx.params);\n  // => { category: 'programming', title: 'how-to-node' } \n});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("通过上面的例子可以看出，我们可以通过 "),a("code",[s._v("ctx.params")]),s._v(" 去访问"),a("code",[s._v("路由中的参数")]),s._v("，使得我们能够对参数做一些处理后再执行后续的代码。")]),s._v(" "),a("h2",{attrs:{id:"http-请求参数传递方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-请求参数传递方式","aria-hidden":"true"}},[s._v("#")]),s._v(" Http 请求参数传递方式")]),s._v(" "),a("ul",[a("li",[s._v("请求参数放在 URL 后面")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http://localhost:3000/home?id=12&name=ikcamp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("koa-router")]),s._v("封装的 "),a("code",[s._v("request")]),s._v(" 对象，里面的 "),a("code",[s._v("query")]),s._v("方法或 "),a("code",[s._v("querystring")]),s._v(" 方法可以直接获取到 Get 请求的数据，唯一不同的是 query 返回的是对象，而 "),a("code",[s._v("querystring")]),s._v(" 返回的是字符串。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  const Koa = require('koa')\n  const router = require('koa-router')()\n  const app = new Koa()\n\n  router.get('/home', async(ctx, next) => {\n    console.log(ctx.request.query)\n    console.log(ctx.request.querystring)\n    ctx.response.body = '<h1>HOME page</h1>'\n  })\n  \n  // add router middleware:\n  app.use(router.routes())\n\n  app.listen(3000, () => {\n    console.log('server is running at http://localhost:3000')\n  })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("运行代码，并打开上述网址发现控制台输出为：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("//类似post方法传递的表单数据格式\n{ id: '12', name: 'ikcamp' }\n//类似get方法传递的数据格式\nid=12&name=ikcamp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[s._v("请求参数放在 URL 中间\nhttp://localhost:3000/home/12/ikcamp\n1\n这种情况下，解析方式肯定与上面的不一样了，koa-router 会把请求参数解析在 params 对象上，我们修改 app.js 文件，增加新的路由来测试下：")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  // 增加如下代码\n  router.get('/home/:id/:name', async(ctx, next)=>{\n    console.log(ctx.params)\n    ctx.response.body = '<h1>HOME page /:id/:name</h1>'\n  })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("运行代码，并通过浏览器访问 http://localhost:3000/home/12/ikcamp，然后查看下控制台显示的日志信息：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("{ id: '12', name: 'ikcamp' }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("请求参数放在 body 中\n当用 post 方式请求时，我们会遇到一个问题：post 请求通常都会通过表单或 JSON 形式发送，而无论是 Node 还是 Koa，都 没有提供 解析 post 请求参数的功能。")])]),s._v(" "),a("p",[s._v("这是我们将使用"),a("code",[s._v("koa-bodyparser")]),s._v("插件。")]),s._v(" "),a("p",[s._v("安装")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm i koa-bodyparser -S\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("安装完成后引入")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa')\n  const router = require('koa-router')()\n  const bodyParser = require('koa-bodyparser')\n  const app = new Koa()\n\n  app.use(bodyParser())\n\n  router.get('/home', async(ctx, next) => {\n    console.log(ctx.request.query)\n    console.log(ctx.request.querystring)\n    ctx.response.body = '<h1>HOME page</h1>'\n  })\n  \n  router.get('/home/:id/:name', async(ctx, next)=>{\n    console.log(ctx.params)\n    ctx.response.body = '<h1>HOME page /:id/:name</h1>'\n  })\n\n  app.use(router.routes())\n\n  app.listen(3000, () => {\n    console.log('server is running at http://localhost:3000')\n  })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("然后我们来试着写一个简单的表单提交实例。修改 app.js 增加如下代码，实现增加表单页面的路由：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('// 增加返回表单页面的路由\n  router.get(\'/user\', async(ctx, next)=>{\n    ctx.response.body = \n    `\n      <form action="/user/register" method="post">\n        <input name="name" type="text" placeholder="请输入用户名：ikcamp"/> \n        <br/>\n        <input name="password" type="text" placeholder="请输入密码：123456"/>\n        <br/> \n        <button>GoGoGo</button>\n      </form>\n    `\n  })\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("继续修改 app.js 增加如下代码，实现 post 表单提交对应的路由：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 增加响应表单请求的路由\n  router.post('/user/register',async(ctx, next)=>{\n    let {name, password} = ctx.request.body\n    if( name === 'ikcamp' && password === '123456' ){\n      ctx.response.body = `Hello， ${name}！`\n    }else{\n      ctx.response.body = '账号信息错误'\n    }\n  })\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h2",{attrs:{id:"koa-例子地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koa-例子地址","aria-hidden":"true"}},[s._v("#")]),s._v(" "),a("a",{attrs:{href:"https://github.com/koajs/examples",target:"_blank",rel:"noopener noreferrer"}},[s._v("koa 例子地址"),a("OutboundLink")],1)])])},[],!1,null,null,null);n.default=t.exports}}]);